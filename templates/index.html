<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SDSS Port DSS – Vendor Risk Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly JS -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .dashboard-header { margin-bottom: 30px; }
        .section { margin-top: 30px; }
        #aisScatterPlot, #risk-chart, #confMatrix { height: 400px; }
    </style>
</head>
<body class="container">
    <div class="dashboard-header text-center">
        <h2>SDSS Port DSS – Vendor Risk Dashboard</h2>
        <p class="lead">Welcome, {{ user_role }}</p>
    </div>
    
    <!-- ML Model Evaluation Section -->
    <div class="alert alert-info text-center section">
        <h5 class="mb-2">ML Model Evaluation</h5>
        <p>Accuracy: <strong>{{ ml_metrics.accuracy }}</strong></p>
        <p>Precision: <strong>{{ ml_metrics.precision }}</strong></p>
        <p>Recall: <strong>{{ ml_metrics.recall }}</strong></p>
        <p>F1 Score: <strong>{{ ml_metrics.f1_score }}</strong></p>
        <h6 class="mt-3">Per-Class Metrics</h6>
        <div class="table-responsive">
            <table class="table table-sm table-bordered mx-auto" style="width: 60%;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Precision</th>
                        <th>Recall</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in ml_report.items() %}
                        {% if key not in ['accuracy', 'macro avg', 'weighted avg'] and key|length <= 2 %}
                        <tr>
                            <td>{{ key }}</td>
                            <td>{{ value.precision }}</td>
                            <td>{{ value.recall }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Confusion Matrix Visualization -->
    <div class="section">
        <h5 class="text-center">Confusion Matrix</h5>
        <div id="confMatrix"></div>
    </div>
    
    <!-- Vessel Scatter Plot Section -->
    <div class="section">
        <h5 class="text-center">Vessel Scatter Plot (AIS Data)</h5>
        <div id="aisScatterPlot"></div>
    </div>
    
    <!-- AIS Alerts Table -->
    <div class="section">
        <h5 class="text-center">AIS Alerts</h5>
        <div id="aisAlertsTable" class="table-responsive"></div>
    </div>
    
    <!-- Filter, Export & Load Sample AIS Button -->
    <div class="section row">
        <div class="col-md-4">
            <form class="d-flex" method="GET" action="/dashboard">
                <select name="risk" class="form-select me-2">
                    <option value="">All Risk Levels</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
                <button class="btn btn-outline-secondary" type="submit">Filter</button>
            </form>
        </div>
        <div class="col-md-4 text-center">
            <a href="/export/csv" class="btn btn-outline-success">Export as CSV</a>
        </div>
        <div class="col-md-4 text-md-end text-center mt-2 mt-md-0">
            <a href="/sample-ais-load" class="btn btn-danger">Load Sample AIS Data</a>
        </div>
    </div>
    
    <!-- Vendor Form -->
    <div class="section">
        <div class="card">
            <div class="card-header">Add New Vendor</div>
            <div class="card-body">
                <form method="POST" action="/add-vendor">
                    <div class="mb-3">
                        <input name="name" class="form-control" placeholder="Vendor Name" required>
                    </div>
                    <div class="mb-3">
                        <input name="software_assets" class="form-control" placeholder="Software Assets (comma-separated)" required>
                    </div>
                    <div class="mb-3">
                        <input name="cloud_assets" class="form-control" placeholder="Cloud Assets (comma-separated)" required>
                    </div>
                    <div class="mb-3">
                        <input name="industrial_assets" class="form-control" placeholder="Industrial Assets (comma-separated)" required>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="ais_data">
                        <label class="form-check-label">AIS Data Available?</label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="use_ml">
                        <label class="form-check-label">Use ML Prediction for Risk?</label>
                    </div>
                    <button class="btn btn-primary" type="submit">Submit Vendor</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ML Risk Prediction Form -->
    <div class="section">
        <div class="card">
            <div class="card-header">ML Risk Prediction (Try It Out)</div>
            <div class="card-body">
                <form id="mlPredictionForm">
                    <div class="mb-3">
                        <input type="number" name="software_count" class="form-control" placeholder="Count of Software Assets" required>
                    </div>
                    <div class="mb-3">
                        <input type="number" name="cloud_count" class="form-control" placeholder="Count of Cloud Assets" required>
                    </div>
                    <div class="mb-3">
                        <input type="number" name="industrial_count" class="form-control" placeholder="Count of Industrial Assets" required>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="ais_data">
                        <label class="form-check-label">AIS Data Available?</label>
                    </div>
                    <button type="button" class="btn btn-warning" onclick="predictRisk()">Predict Risk</button>
                </form>
                <div id="predictionResult" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- Vendor Table -->
    <div class="section">
        <h4>All Vendors</h4>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Software</th>
                        <th>Cloud</th>
                        <th>Industrial</th>
                        <th>AIS</th>
                        <th>Score</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in vendors %}
                    <tr>
                        <td>{{ vendor.name }}</td>
                        <td>{{ vendor.software_assets }}</td>
                        <td>{{ vendor.cloud_assets }}</td>
                        <td>{{ vendor.industrial_assets }}</td>
                        <td>{{ 'Yes' if vendor.ais_data else 'No' }}</td>
                        <td>{{ vendor.cybersecurity_score }}</td>
                        <td><strong>{{ vendor.risk_level }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Risk Score Chart -->
    <div class="section">
        <h4 class="text-center">Risk Score Chart</h4>
        <div id="risk-chart"></div>
    </div>
    
    <!-- JavaScript for all plotting and AJAX calls -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Plot risk chart using Plotly
            const labels = {{ chart_labels | tojson }};
            const scores = {{ chart_scores | tojson }};
            const chartData = [{
                x: labels,
                y: scores,
                type: 'bar',
                marker: { color: 'tomato' }
            }];
            Plotly.newPlot('risk-chart', chartData);
            
            // Plot confusion matrix using Plotly
            var confMatrixData = {{ confusion_matrix_data | tojson }};
            Plotly.newPlot('confMatrix', [{
                z: confMatrixData,
                type: 'heatmap',
                colorscale: 'Viridis'
            }], {
                title: 'Confusion Matrix',
                xaxis: { title: 'Predicted Label' },
                yaxis: { title: 'True Label' }
            });
            
            // Plot AIS Vessel Scatter Plot using Plotly
            var aisData = {{ ais_alerts | tojson }};
            var longitudes = [];
            var latitudes = [];
            var markerColors = [];
            var hoverTexts = [];
            aisData.forEach(function(d) {
                longitudes.push(d.longitude);
                latitudes.push(d.latitude);
                var inZone = (d.latitude >= 55.65 && d.latitude <= 55.70 && d.longitude >= 12.55 && d.longitude <= 12.60);
                markerColors.push((d.speed > 25 || inZone) ? 'red' : 'blue');
                hoverTexts.push(d.vessel_name + "<br>Speed: " + d.speed + " knots<br>" + d.timestamp);
            });
            var scatterData = [{
                x: longitudes,
                y: latitudes,
                mode: 'markers',
                marker: { color: markerColors, size: 12 },
                text: hoverTexts,
                hoverinfo: 'text'
            }];
            var layoutScatter = {
                title: 'AIS Vessel Positions',
                xaxis: { title: 'Longitude' },
                yaxis: { title: 'Latitude' }
            };
            Plotly.newPlot('aisScatterPlot', scatterData, layoutScatter);
            
            // Update AIS Alerts Table every 10 seconds
            function updateAisAlerts() {
                fetch('/ais-alerts')
                .then(response => response.json())
                .then(data => {
                    let alertsHTML = '<table class="table table-bordered"><thead><tr><th>Vessel</th><th>Speed</th><th>Timestamp</th></tr></thead><tbody>';
                    data.ais_alerts.forEach(function(alert) {
                        alertsHTML += `<tr><td>${alert.vessel_name}</td><td>${alert.speed}</td><td>${alert.timestamp}</td></tr>`;
                    });
                    alertsHTML += '</tbody></table>';
                    document.getElementById('aisAlertsTable').innerHTML = alertsHTML;
                })
                .catch(error => console.error("Error fetching AIS alerts:", error));
            }
            updateAisAlerts();
            setInterval(updateAisAlerts, 10000);
            
            // ML Prediction Function
            document.querySelector("button.btn-warning").addEventListener("click", function () {
                const form = document.getElementById('mlPredictionForm');
                const formData = new FormData(form);
                const payload = {
                    software_count: formData.get('software_count'),
                    cloud_count: formData.get('cloud_count'),
                    industrial_count: formData.get('industrial_count'),
                    ais_data: formData.get('ais_data') ? 1 : 0
                };
                fetch('/predict-risk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('predictionResult').innerHTML = data.predicted_risk ?
                        `<strong>Predicted Risk Level: ${data.predicted_risk}</strong>` :
                        `Error: ${data.error}`;
                })
                .catch(error => {
                    document.getElementById('predictionResult').innerHTML = `Error: ${error}`;
                });
            });
        });
    </script>
</body>
</html>
